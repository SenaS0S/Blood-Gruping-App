{% extends "base.html" %}
{% block title %}Grid Analysis{% endblock %}

{% block content %}
<style>
    .card {
        background: var(--card-bg);
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        border-radius: 16px;
        border: 1px solid var(--border-color);
        padding: 2rem;
    }
    .header { text-align: center; }
    .header h1 { font-weight: 800; font-size: 1.8rem; color: #fff; }
    .header p { font-size: 1rem; margin-top: 0.5rem; color: var(--text-muted); }
    #upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        padding: 2.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 2rem;
    }
    #upload-area:hover, #upload-area.drag-over {
        border-color: var(--accent-color);
        background-color: rgba(230, 57, 70, 0.1);
    }
    #upload-area p { margin: 0; font-weight: 600; font-size: 1.1rem; }
    #file-name { margin-top: 1rem; text-align: left; color: var(--text-muted); }
    #submit-btn {
        background-color: var(--accent-color);
        color: white;
        border: none;
        padding: 0.9rem 1.5rem;
        font-size: 1rem;
        font-weight: 700;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
        margin-top: 1.5rem;
    }
    #submit-btn:disabled { background-color: rgba(241, 250, 238, 0.2); color: var(--text-muted); cursor: not-allowed; }
    #spinner { border: 4px solid rgba(255, 255, 255, 0.2); width: 24px; height: 24px; border-radius: 50%; border-left-color: white; animation: spin 1s ease infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<div class="card">
    <div class="header">
        <h1>Grid Image Analysis</h1>
        <p>Upload a single image containing a grid of multiple blood samples.</p>
    </div>
    
    <form action="{{ url_for('batch_process') }}" method="post" enctype="multipart/form-data" id="batch-form">
        <input type="file" id="file-input" name="file" accept="image/*" hidden>
        <div id="upload-area">
            <p id="upload-text">Click or drag a single grid image here</p>
            <div id="file-name"></div>
        </div>
        <button type="submit" id="submit-btn" disabled>
            <span id="button-text">Analyze Grid</span>
            <div id="spinner" style="display: none;"></div>
        </button>
    </form>
</div>

<script>
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const fileNameEl = document.getElementById('file-name');
    const submitBtn = document.getElementById('submit-btn');
    const buttonText = document.getElementById('button-text');
    const spinner = document.getElementById('spinner');

    uploadArea.addEventListener('click', () => fileInput.click());
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, preventDefaults, false));
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    ['dragenter', 'dragover'].forEach(eventName => uploadArea.addEventListener(eventName, () => uploadArea.classList.add('drag-over'), false));
    ['dragleave', 'drop'].forEach(eventName => uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('drag-over'), false));
    uploadArea.addEventListener('drop', handleDrop, false);
    fileInput.addEventListener('change', handleFileSelect);

    function handleDrop(e) { handleFiles(e.dataTransfer.files); }
    function handleFileSelect(e) { handleFiles(e.target.files); }

    function handleFiles(files) {
        if (files.length > 0) {
            fileInput.files = files;
            fileNameEl.textContent = `File selected: ${files[0].name}`;
            submitBtn.disabled = false;
        }
    }

    document.getElementById('batch-form').addEventListener('submit', () => {
        spinner.style.display = 'block';
        buttonText.style.display = 'none';
        submitBtn.disabled = true;
    });
</script>
{% endblock %}
